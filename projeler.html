<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etkinliklerimiz - BBAT</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/pngikologo.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Quicksand:wght@400&display=swap" rel="stylesheet">
    
    <style>
        /* Lightbox & Galeri */
        .lightbox-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .lightbox-overlay img {
            max-width: 90%; max-height: 90%; border: 5px solid white; border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .lightbox-controls {
            position: absolute; top: 50%; width: 100%; display: flex;
            justify-content: space-between; transform: translateY(-50%); pointer-events: none;
        }
        .lightbox-controls button {
            background: rgba(255, 255, 255, 0.1); color: white; border: none;
            font-size: 3rem; padding: 20px; cursor: pointer; pointer-events: auto;
            transition: background 0.3s;
        }
        .lightbox-controls button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .media-scroller {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; margin: 20px 0;
            scrollbar-width: thin; scrollbar-color: #a90000 #eee;
        }
        .media-item {
            height: 200px; width: auto; border-radius: 8px; flex-shrink: 0; cursor: pointer;
            transition: transform 0.2s; object-fit: cover;
        }
        .media-item:hover { transform: scale(1.02); }

        .comment-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .comments-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;}
        .comments-list li { padding: 5px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .comment-input-area { display: flex; gap: 10px; margin-top: 10px; }
        .comment-input-area textarea { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .comment-btn { background: #a90000; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; }
    </style>
</head>

<body>

    <header>
        <div class="brand-container">
            <img src="https://github.com/Riwelda/BBAT/blob/main/unilogo.jpg?raw=true" alt="Kastamonu Üni Logo">
            <div class="site-title" style="margin: 0 15px; text-align:center;">
                <h1>BİYOLOJİK BİLİMLER<br>ARAŞTIRMA TOPLULUĞU</h1>
            </div>
            <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/pngikologo.png" alt="BBAT Logo">
        </div>
        <div class="menu-toggle" id="menu-toggle">&#9776;</div>
        <nav class="nav-links" id="nav-links">
            <ul>
                <li><a href="index.html">Anasayfa</a></li>
                <li><a href="hakkimizda.html">Hakkımızda</a></li>
                <li><a href="projeler.html">Etkinlikler</a></li>
                <li><a href="iletisim.html">İletişim</a></li>
            </ul>
            <div class="auth-buttons-container">
                <div id="auth-buttons" style="display: flex; gap: 10px;">
                    <button id="login-btn" class="btn btn-outline">Giriş Yap</button>
                    <button id="signup-btn" class="btn btn-primary">Kayıt Ol</button>
                </div>
                <div id="user-info" style="display: none; align-items: center; gap: 10px;">
                    <span id="welcome-text" style="font-weight: bold; color: #a90000; font-size: 0.9rem;"></span>
                    <button id="logout-btn" class="btn btn-primary" style="background-color: #333;">Çıkış</button>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="hero-wrapper">
            <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/fenfak.jpeg" alt="Etkinlikler" class="hero-img">
            <div class="hero-content">
                <h1>Etkinliklerimiz</h1>
                <p>Geçmişten günümüze BBAT faaliyetleri</p>
            </div>
        </div>

        <div id="dynamic-events-container">
            </div>

        <article class="post" data-post-id="post1">
            <h2>CİDE TOPLULUK BAŞKANLARI TOPLANTISI</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 5 Haziran 2025</span>
            <p>Biyolojik Bilimler Araştırma Topluluğu olarak, 2-3 Haziran topluluk başkanları toplantısına katılım sağladık.</p>
            <div class="media-scroller gallery-group">
                <video class="media-item" controls><source src="https://github.com/Riwelda/BBAT/raw/refs/heads/main/bt1.mp4" type="video/mp4"></video>
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/bt2.jpg" class="media-item" alt="Cide 2">
                <video class="media-item" controls><source src="https://github.com/Riwelda/BBAT/raw/refs/heads/main/bt3.mp4" type="video/mp4"></video>
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post1"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post1" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post1')">Gönder</button>
                </div>
            </div>
        </article>

        <article class="post" data-post-id="post2">
            <h2>22 MART DÜNYA SU GÜNÜ PANELİ</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 26 Mart 2025</span>
            <p>Erimekte Olan Geleceğimiz! Bir buzdağı yok olduğunda sadece su kaybolmaz, bir ekosistem, bir yaşam, bir gelecek de kaybolur…</p>
            <div class="media-scroller gallery-group">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(1).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(2).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(3).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(4).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(5).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/panel%20(6).jpg" class="media-item">
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post2"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post2" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post2')">Gönder</button>
                </div>
            </div>
        </article>

        <article class="post" data-post-id="post3">
            <h2>BÖLÜM KAHVALTISI</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 29 Aralık 2024</span>
            <p>Biyoloji bölümü olarak düzenlediğimiz kahvaltı etkinliği ile yılı kapatıyoruz ✨</p>
            <div class="media-scroller gallery-group">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/kahvalti%20(1).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/kahvalti%20(2).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/kahvalti%20(3).jpg" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/kahvalti%20(4).jpg" class="media-item">
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post3"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post3" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post3')">Gönder</button>
                </div>
            </div>
        </article>

        <article class="post" data-post-id="post4">
            <h2>BIOINNOVATION 2024</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 5 Mayıs 2024</span>
            <div class="media-scroller gallery-group">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/bioyeni%20(1).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/bioyeni%20(2).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/bioyeni%20(3).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/bioyeni%20(4).webp" class="media-item">
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post4"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post4" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post4')">Gönder</button>
                </div>
            </div>
        </article>

        <article class="post" data-post-id="post5">
            <h2>SÖZDE BİLİM KONFERANSI</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 4 Aralık 2023</span>
            <div class="media-scroller gallery-group">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/sozdebilim%20(2).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/sozdebilim%20(3).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/sozdebilim%20(4).webp" class="media-item">
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post5"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post5" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post5')">Gönder</button>
                </div>
            </div>
        </article>

        <article class="post" data-post-id="post6">
            <h2>ILGAZ DAĞI MANTAR YÜRÜYÜŞÜ</h2>
            <span class="meta">Yazar: Alper YAMAN | Tarih: 25 Ekim 2023</span>
            <div class="media-scroller gallery-group">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/mantaretkinlik%20(1).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/mantaretkinlik%20(2).webp" class="media-item">
                <img src="https://raw.githubusercontent.com/Riwelda/BBAT/refs/heads/main/mantaretkinlik%20(3).webp" class="media-item">
            </div>
            <div class="comment-section">
                <h4>Yorumlar</h4>
                <ul class="comments-list" id="comments-post6"></ul>
                <div class="comment-input-area">
                    <textarea id="comment-input-post6" placeholder="Yorum yaz..."></textarea>
                    <button class="comment-btn" onclick="submitComment('post6')">Gönder</button>
                </div>
            </div>
        </article>

    </main>

    <footer>
        <p>&copy; 2025 BBAT, Kastamonu Üniversitesine Bağlı Bir Öğrenci Topluluğudur.</p>
    </footer>

    <div class="lightbox-overlay" id="lightbox">
        <div class="lightbox-controls">
            <button id="prev-btn">&#10094;</button>
            <button id="next-btn">&#10095;</button>
        </div>
        <img id="lightbox-img" src="" alt="Görsel">
    </div>

    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const navLinks = document.getElementById('nav-links');
        if(menuToggle) menuToggle.addEventListener('click', () => navLinks.classList.toggle('active'));

        document.getElementById("signup-btn").addEventListener("click", () => window.location.href = "register.html");
        document.getElementById("login-btn").addEventListener("click", () => window.location.href = "login.html");

        // --- GALERİ MANTIĞI ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        let currentGalleryImages = [];
        let currentIndex = 0;

        // Statik resimler için
        document.querySelectorAll('img.media-item').forEach(img => {
            img.addEventListener('click', () => showImage(img));
        });

        // Dinamik resimler için (Admin panelinden gelenler)
        window.showImage = function(imgElement) {
            const group = imgElement.closest('.gallery-group');
            if (!group) {
                currentGalleryImages = [imgElement];
            } else {
                currentGalleryImages = Array.from(group.querySelectorAll('img.media-item'));
            }

            const index = currentGalleryImages.indexOf(imgElement);
            if(index === -1) return;
            
            currentIndex = index;
            updateLightboxImage();
            
            if (currentGalleryImages.length > 1) {
                if(prevBtn) prevBtn.style.display = 'block';
                if(nextBtn) nextBtn.style.display = 'block';
            } else {
                if(prevBtn) prevBtn.style.display = 'none';
                if(nextBtn) nextBtn.style.display = 'none';
            }

            lightbox.style.display = 'flex';
        }

        function updateLightboxImage() {
            lightboxImg.src = currentGalleryImages[currentIndex].src;
        }

        function navigateLightbox(direction) {
            if (currentGalleryImages.length <= 1) return;
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = currentGalleryImages.length - 1;
            if (currentIndex >= currentGalleryImages.length) currentIndex = 0;
            updateLightboxImage();
        }

        if(prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); navigateLightbox(-1); });
        if(nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); navigateLightbox(1); });
        if(lightbox) lightbox.addEventListener('click', () => { lightbox.style.display = 'none'; currentGalleryImages = []; });
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAdPt8XuUEzJugYI2R9NpUXUCUQXttHaXI",
            authDomain: "bbat-295c4.firebaseapp.com",
            projectId: "bbat-295c4",
            appId: "1:849546748999:web:476431352773d260fcfd62"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-buttons').style.display = 'none';
                document.getElementById('user-info').style.display = 'flex';
                
                const adminEmail = "alperymnay@gmail.com"; 
                if(user.email === adminEmail && !document.getElementById('admin-link')) {
                    const li = document.createElement('li');
                    li.innerHTML = '<a href="admin.html" id="admin-link" style="color:red; font-weight:bold;">YÖNETİM</a>';
                    document.querySelector('.nav-links ul').appendChild(li);
                }

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    let username = user.email.split('@')[0];
                    if (userDoc.exists && userDoc.data().username) username = userDoc.data().username;
                    document.getElementById('welcome-text').textContent = `Merhaba, ${username}`;
                } catch (e) {
                    document.getElementById('welcome-text').textContent = `Merhaba, ${user.email.split('@')[0]}`;
                }
            } else {
                document.getElementById('auth-buttons').style.display = 'flex';
                document.getElementById('user-info').style.display = 'none';
                if(document.getElementById('admin-link')) document.getElementById('admin-link').parentElement.remove();
            }
        });

        document.getElementById("logout-btn").addEventListener("click", () => {
            auth.signOut().then(() => window.location.reload());
        });

        // --- YENİ: DİNAMİK ETKİNLİKLERİ ÇEKME ---
        db.collection('etkinlikler').orderBy('olusturulmaTarihi', 'desc').onSnapshot(snapshot => {
            const container = document.getElementById('dynamic-events-container');
            container.innerHTML = ""; // Temizle

            snapshot.forEach(doc => {
                const data = doc.data();
                const postId = doc.id; 

                // HTML Oluştur
                let resimHTML = '';
                if(data.kapakResmi && data.kapakResmi.length > 5) {
                    resimHTML = `
                    <div class="media-scroller gallery-group">
                        <img src="${data.kapakResmi}" class="media-item" onclick="showImage(this)"> 
                    </div>`;
                }

                const eventHTML = `
                    <article class="post" data-post-id="${postId}">
                        <h2>${data.baslik}</h2>
                        <span class="meta">Yazar: ${data.yazar} | Tarih: ${data.tarih}</span>
                        <p style="white-space: pre-wrap;">${data.aciklama}</p>
                        ${resimHTML}
                        <div class="comment-section">
                            <h4>Yorumlar</h4>
                            <ul class="comments-list" id="comments-${postId}"></ul>
                            <div class="comment-input-area">
                                <textarea id="comment-input-${postId}" placeholder="Yorum yaz..."></textarea>
                                <button class="comment-btn" onclick="submitComment('${postId}')">Gönder</button>
                            </div>
                        </div>
                    </article>
                `;
                
                container.innerHTML += eventHTML;
                
                // Yorumları dinle
                listenForComments(postId);
            });
        });

        // --- YORUM SİSTEMİ ---
        window.submitComment = async function(postId) {
            const val = document.getElementById(`comment-input-${postId}`).value.trim();
            if (!val) return;
            if (!currentUser) { alert("Lütfen giriş yapın."); return; }
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const username = userDoc.exists && userDoc.data().username ? userDoc.data().username : currentUser.email.split('@')[0];
                await db.collection("comments").add({
                    postId: postId, uid: currentUser.uid, username: username, text: val, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById(`comment-input-${postId}`).value = "";
            } catch (err) { alert("Yorum hatası: " + err.message); }
        };

        // Yorum sıralaması - JS ile (Index hatasını önlemek için)
function listenForComments(postId) {
    db.collection("comments").where("postId", "==", postId)
      .onSnapshot((snap) => {
          const list = document.getElementById(`comments-${postId}`);
          if(list) {
              list.innerHTML = "";
              let comments = [];
              snap.forEach(doc => comments.push(doc.data()));
              
              // Tarihe göre sıralama (Eskiden yeniye)
              comments.sort((a, b) => {
                  const t1 = a.timestamp ? a.timestamp.seconds : 0;
                  const t2 = b.timestamp ? b.timestamp.seconds : 0;
                  return t1 - t2;
              });

              comments.forEach(d => {
                  const li = document.createElement("li");

                  // --- GÜVENLİK GÜNCELLEMESİ BAŞLANGIÇ ---
                  // 1. Kullanıcı adını oluştur (Kalın ve Kırmızı)
                  const strong = document.createElement("strong");
                  strong.textContent = d.username + ": ";
                  strong.style.color = "#a90000"; 

                  // 2. Yorum metnini oluştur (Düz Metin - Güvenli)
                  const textSpan = document.createElement("span");
                  textSpan.textContent = d.text; 
                  // textContent kullanınca, içine kod yazsalar bile çalışmaz, yazı olarak görünür.

                  // 3. Parçaları birleştir
                  li.appendChild(strong);
                  li.appendChild(textSpan);
                  // --- GÜVENLİK GÜNCELLEMESİ BİTİŞ ---

                  list.appendChild(li);
              });
          }
      });
}
        // Statik postlar için dinleyici başlat
        document.querySelectorAll(".post").forEach(post => listenForComments(post.getAttribute("data-post-id")));
    </script>
</body>
</html>
